#!/usr/bin/env bash
# Pre-push hook to prevent direct pushes to main branch
#
set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the current branch
current_branch=$(git symbolic-ref --short HEAD)

# Read stdin to get the remote ref being pushed
while read local_ref local_sha remote_ref remote_sha; do
  # Extract the branch name from the remote ref
  remote_branch=$(echo "$remote_ref" | sed 's/refs\/heads\///')

  # Check if pushing to main
  if [ "$remote_branch" = "main" ]; then
    echo -e "${RED}‚ùå ERROR: Direct pushes to 'main' branch are not allowed!${NC}"
    echo ""
    echo -e "${YELLOW}Please use the Pull Request workflow:${NC}"
    echo "  1. Create/switch to a feature branch:"
    echo "     git checkout -b feature/your-feature"
    echo ""
    echo "  2. Make your changes and commit"
    echo ""
    echo "  3. Push to your feature branch:"
    echo "     git push origin feature/your-feature"
    echo ""
    echo "  4. Create a Pull Request on GitHub"
    echo ""
    echo "  5. Merge via GitHub UI after checks pass"
    echo ""
    echo -e "${GREEN}Current branch: $current_branch${NC}"
    echo ""
    echo "See README.md for detailed PR workflow documentation."
    echo ""
    echo "To bypass this check (NOT recommended):"
    echo "  git push --no-verify origin main"
    exit 1
  fi
done

# If we get here, the push is allowed
exit 0
